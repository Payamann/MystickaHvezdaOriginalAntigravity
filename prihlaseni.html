<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>P≈ôihl√°≈°en√≠ | Mystick√° Hvƒõzda</title>
    <meta name="robots" content="noindex, nofollow">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîÆ</text></svg>">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="css/style.v2.min.css?v=3">

    <!-- Scripts -->





</head>

<body>
    <!-- STARS BACKGROUND -->
    <div class="stars" aria-hidden="true"></div>

    <!-- HEADER -->
    <div id="header-placeholder"></div>

    <main>
        <section class="login-section">
            <div class="login-card" data-animate>
                <div class="login-header">
                    <span class="login-icon">ü¶â</span>
                    <h1 class="hero__title" style="font-size: 2rem; margin-bottom: 0.5rem;">V√≠tejte zpƒõt</h1>
                    <p class="hero__subtitle" style="font-size: 1rem;">P≈ôihlaste se ke sv√©mu √∫ƒçtu</p>
                </div>

                <!-- Using the same ID as the modal form to reuse Auth logic -->
                <form id="login-form">
                    <div class="form-group">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" id="email" name="email" class="form-input" placeholder="vas@email.cz"
                            required autocomplete="email">
                    </div>

                    <div class="form-group">
                        <label for="password" class="form-label">Heslo</label>
                        <input type="password" id="password" name="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            required autocomplete="current-password">
                    </div>

                    <button type="submit" id="auth-submit" class="btn btn--primary btn--glow"
                        style="width: 100%; margin-top: 1rem;">
                        P≈ôihl√°sit se
                    </button>
                </form>

                <!-- Forgot Password Link -->
                <div style="margin-top: 1rem; text-align: center;">
                    <button id="forgot-password-link" class="btn btn--text"
                        style="color: var(--color-silver-mist); font-size: 0.9rem;">
                        Zapomnƒõli jste heslo?
                    </button>
                </div>

                <!-- Forgot Password Form (Hidden by default) -->
                <form id="forgot-password-form" style="display: none;">
                    <div class="form-group">
                        <label for="forgot-email" class="form-label">Email</label>
                        <input type="email" id="forgot-email" class="form-input" placeholder="vas@email.cz" required>
                    </div>
                    <button type="submit" class="btn btn--primary btn--glow" style="width: 100%; margin-top: 1rem;">
                        Odeslat odkaz pro obnoven√≠
                    </button>
                    <button type="button" id="back-to-login" class="btn btn--text"
                        style="width: 100%; margin-top: 0.5rem; color: var(--color-silver-mist);">
                        Zpƒõt na p≈ôihl√°≈°en√≠
                    </button>
                </form>

                <!-- Reset Password Form (Hidden, shown when ?reset=true) -->
                <form id="reset-password-form" style="display: none;">
                    <div class="form-group">
                        <label for="new-password" class="form-label">Nov√© heslo</label>
                        <input type="password" id="new-password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required
                            minlength="8">
                    </div>
                    <div class="form-group">
                        <label for="confirm-password" class="form-label">Potvrƒète heslo</label>
                        <input type="password" id="confirm-password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required
                            minlength="8">
                    </div>
                    <button type="submit" class="btn btn--primary btn--glow" style="width: 100%; margin-top: 1rem;">
                        Nastavit nov√© heslo
                    </button>
                </form>

                <div style="margin-top: 2rem; font-size: 0.9rem; color: var(--color-silver-mist);">
                    <button id="auth-mode-toggle" class="btn btn--text" style="color: var(--color-mystic-gold);">
                        Nem√°te √∫ƒçet? Zaregistrujte se
                    </button>
                </div>

                <!-- Hidden Register Fields (Managed by auth-client.js toggleMode) -->
                <div id="register-fields" style="display: none; text-align: left; margin-top: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Jm√©no</label>
                        <input type="text" name="first_name" class="form-input" placeholder="Va≈°e jm√©no">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Datum narozen√≠</label>
                        <input type="date" name="birth_date" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">M√≠sto narozen√≠</label>
                        <input type="text" name="birth_place" class="form-input" placeholder="Nap≈ô. Praha">
                    </div>
                </div>

                <!-- Header for Register Mode (Hidden by default, updated by JS) -->
                <h1 id="auth-title" class="sr-only">P≈ôihl√°≈°en√≠</h1>

            </div>
        </section>
    </main>

    <!-- FOOTER -->
    <div id="footer-placeholder"></div>

    <!-- Handling Redirect Logic from URL -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Auth-client.js automatically binds to #login-form and handles submission.
            // It also handles #auth-mode-toggle.
            // We just need to check if we are already logged in, and if so, redirect back.

            const loginForm = document.getElementById('login-form');
            const forgotPasswordForm = document.getElementById('forgot-password-form');
            const resetPasswordForm = document.getElementById('reset-password-form');
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const backToLoginBtn = document.getElementById('back-to-login');
            const loginHeader = document.querySelector('.login-header h1');
            const loginSubtitle = document.querySelector('.login-header p');

            // Check for reset token in URL
            const urlParams = new URLSearchParams(window.location.search);
            const isResetMode = urlParams.get('reset') === 'true';
            const hash = window.location.hash;

            if (isResetMode && hash) {
                // Show reset password form
                loginForm.style.display = 'none';
                forgotPasswordForm.style.display = 'none';
                resetPasswordForm.style.display = 'block';
                forgotPasswordLink.style.display = 'none';
                document.getElementById('auth-mode-toggle').parentElement.style.display = 'none';
                loginHeader.textContent = 'Obnoven√≠ hesla';
                loginSubtitle.textContent = 'Zadejte nov√© heslo';
            }

            // Forgot password link click
            forgotPasswordLink?.addEventListener('click', () => {
                loginForm.style.display = 'none';
                forgotPasswordForm.style.display = 'block';
                forgotPasswordLink.style.display = 'none';
                document.getElementById('auth-mode-toggle').parentElement.style.display = 'none';
                loginHeader.textContent = 'Zapomenut√© heslo';
                loginSubtitle.textContent = 'Zadejte sv≈Øj email';
            });

            // Back to login
            backToLoginBtn?.addEventListener('click', () => {
                loginForm.style.display = 'block';
                forgotPasswordForm.style.display = 'none';
                forgotPasswordLink.style.display = 'block';
                document.getElementById('auth-mode-toggle').parentElement.style.display = 'block';
                loginHeader.textContent = 'V√≠tejte zpƒõt';
                loginSubtitle.textContent = 'P≈ôihlaste se ke sv√©mu √∫ƒçtu';
            });

            // Forgot password form submission
            forgotPasswordForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('forgot-email').value;
                const submitBtn = forgotPasswordForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;

                submitBtn.textContent = 'Odes√≠l√°m...';
                submitBtn.disabled = true;

                try {
                    const response = await fetch('/api/auth/forgot-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });

                    const data = await response.json();

                    if (data.success) {
                        if (window.Auth?.showToast) {
                            window.Auth.showToast('Email odesl√°n', data.message, 'success');
                        } else {
                            alert(data.message);
                        }
                        // Go back to login
                        backToLoginBtn.click();
                    } else {
                        throw new Error(data.error || 'Chyba p≈ôi odes√≠l√°n√≠ emailu');
                    }
                } catch (error) {
                    if (window.Auth?.showToast) {
                        window.Auth.showToast('Chyba', error.message, 'error');
                    } else {
                        alert(error.message);
                    }
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });

            // Reset password form submission
            resetPasswordForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;

                if (newPassword !== confirmPassword) {
                    if (window.Auth?.showToast) {
                        window.Auth.showToast('Chyba', 'Hesla se neshoduj√≠', 'error');
                    } else {
                        alert('Hesla se neshoduj√≠');
                    }
                    return;
                }

                const submitBtn = resetPasswordForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Ukl√°d√°m...';
                submitBtn.disabled = true;

                try {
                    // Extract access_token from URL hash
                    const hashParams = new URLSearchParams(hash.substring(1));
                    const accessToken = hashParams.get('access_token');

                    if (!accessToken) {
                        throw new Error('Neplatn√Ω odkaz pro obnoven√≠ hesla');
                    }

                    const response = await fetch('/api/auth/reset-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({ password: newPassword })
                    });

                    const data = await response.json();

                    if (data.success) {
                        if (window.Auth?.showToast) {
                            window.Auth.showToast('√öspƒõch', 'Heslo bylo zmƒõnƒõno. M≈Ø≈æete se p≈ôihl√°sit.', 'success');
                        } else {
                            alert('Heslo bylo zmƒõnƒõno. M≈Ø≈æete se p≈ôihl√°sit.');
                        }
                        // Redirect to login
                        window.location.href = '/prihlaseni.html';
                    } else {
                        throw new Error(data.error || 'Chyba p≈ôi zmƒõnƒõ hesla');
                    }
                } catch (error) {
                    if (window.Auth?.showToast) {
                        window.Auth.showToast('Chyba', error.message, 'error');
                    } else {
                        alert(error.message);
                    }
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });

            setTimeout(() => {
                if (window.Auth && window.Auth.isLoggedIn()) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const redirect = urlParams.get('redirect');
                    if (redirect) {
                        window.location.href = redirect;
                    } else {
                        window.location.href = '/profil.html';
                    }
                }
            }, 500); // Small delay to let Auth init
        });

        // Handle "auth:changed" event from auth-client.js
        document.addEventListener('auth:changed', () => {
            if (window.Auth && window.Auth.isLoggedIn()) {
                const urlParams = new URLSearchParams(window.location.search);
                const redirect = urlParams.get('redirect') || '/profil.html';
                // prevent infinite loop if redirect points to self
                if (!redirect.includes('login.html')) {
                    window.location.href = redirect;
                }
            }
        });
    </script>

    <script src="js/api-config.js?v=5" defer></script>
    <script src="js/templates.js?v=5" defer></script>
    <script src="js/auth-client.js?v=5" defer></script>
    <script src="js/components.js?v=5" defer></script>
    <script type="module" src="js/main.js?v=5"></script>

</body>

</html>
